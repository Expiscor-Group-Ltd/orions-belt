{# SPDX-License-Identifier: MIT
# Copyright (c) 2024 Marko Sarunac
#
# Part of the Orion's Belt project.
# Repository: https://github.com/Expiscor-Group-Ltd/orions-belt
# Template ID: OB-008-T

# Nftables firewall configuration template
# This template is used by OB-008 (configure_firewall_tasks.yml) #}

# nftables configuration for Debian 12 Security Hardening

#!/usr/sbin/nft -f

# Security Hardening Firewall Configuration
# Generated by Ansible Security Hardening Playbook
# Local subnet: {{ local_subnet }}

flush ruleset

# Define tables
table inet filter {
    # Define sets for allowed ports
    set allowed_tcp_ports {
        type inet_service
        flags interval
        auto-merge
        elements = {
            {% for port in allowed_ports %}
            {{ port }}{% if not loop.last %},{% endif %}
            {% endfor %}
        }
    }

    # Define sets for local subnet
    set local_subnet {
        type ipv4_addr
        flags interval
        elements = { {{ local_subnet }} }
    }

    # Define chains
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Allow established and related connections
        ct state established,related accept
        
        # Allow loopback traffic
        iif lo accept
        
        # Allow ICMP (ping)
        icmp type echo-request accept
        icmpv6 type echo-request accept
        
        # Allow SSH from local subnet only
        tcp dport 22 ip saddr @local_subnet accept
        
        # Allow specified TCP ports from anywhere
        tcp dport @allowed_tcp_ports accept
        
        # Log dropped packets
        log prefix "nftables dropped: " group 0
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
        
        # Allow established and related connections
        ct state established,related accept
        
        # Log dropped packets
        log prefix "nftables forward dropped: " group 0
    }

    chain output {
        type filter hook output priority 0; policy accept;
        
        # Allow all outbound traffic
    }
}

# Enable NAT for outbound connections
table inet nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        
        # Masquerade outbound connections
        oifname != lo masquerade
    }
}

# Optional: Rate limiting for SSH
table inet filter {
    chain input {
        # Rate limit SSH connections to prevent brute force
        tcp dport 22 ip saddr @local_subnet limit rate 5/minute accept
    }
} 